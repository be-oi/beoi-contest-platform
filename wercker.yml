box: debian
build:
  steps:
    - script:
      name: set version
      code: date +%Y%m%dT%H%M%S > $WERCKER_CACHE_DIR/VERSION
build-docker:
  steps:
    - script:
      name: get version
      code: export VERSION="`cat $WERCKER_CACHE_DIR/VERSION`"
    - internal/docker-push:
      username: $DOCKERHUB_USERNAME
      password: $DOCKERHUB_PASSWORD
      tag: $VERSION
      repository: beoi/beoi-contest-platform
      registry: https://registry.hub.docker.com
    - internal/docker-push:
      username: $DOCKERHUB_USERNAME
      password: $DOCKERHUB_PASSWORD
      tag: latest
      repository: beoi/beoi-contest-platform
      registry: https://registry.hub.docker.com
new-eb-version:
  steps:
    - script:
      name: upload new version
      code: |
        VERSION="`cat $WERCKER_CACHE_DIR/VERSION`"
        REPOSITORY="beoi/beoi-contest-platform"
        IMAGENAME=$VERSION
        BUCKETNAME=elasticbeanstalk-eu-central-1-997893130250
        BUCKETPREFIX=contest-platform/
        REGION=eu-central-1
        EBAPPNAME=contest-platform

        info 'Installing pip...'
        sudo apt-get update
        sudo apt-get install -y python-pip libpython-all-dev zip

        info 'Installing the AWS CLI...';
        sudo pip install awscli;

        mkdir -p $HOME/.aws
        echo '[default]' > $HOME/.aws/config
        echo 'output = json' >> $HOME/.aws/config
        echo "region = $REGION" >> $HOME/.aws/config
        echo "aws_access_key_id = $AWS_KEY" >> $HOME/.aws/config
        echo "aws_secret_access_key = $AWS_SECRET" >> $HOME/.aws/config

        echo "{
          \"AWSEBDockerrunVersion\": \"1\",
          \"Image\": {
            \"Name\": \"$REPOSITORY:$IMAGENAME\",
            \"Update\": \"true\"
          },
          \"Ports\": [
            {
              \"ContainerPort\": \"80\"
            }
          ],
          \"Logging\": \"/var/www/html/logs\"
        }" > Dockerrun.aws.json
        zip -r RELEASE.zip Dockerrun.aws.json .ebextensions
        aws s3 cp RELEASE.zip s3://$BUCKETNAME/$BUCKETPREFIX$VERSION --acl private
        aws elasticbeanstalk create-application-version --application-name $EBAPPNAME --version-label $VERSION --source-bundle S3Bucket=$BUCKETNAME,S3Key=$BUCKETPREFIX$VERSION
