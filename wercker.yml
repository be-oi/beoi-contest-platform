box: debian
build:
  steps:
    - script:
      name: set version
      code: date +%Y%m%dT%H%M%S > $WERCKER_CACHE_DIR/VERSION
build-docker:
  steps:
    - script:
      name: get version
      code: export VERSION="`cat $WERCKER_CACHE_DIR/VERSION`"
    - internal/docker-push:
      username: $DOCKERHUB_USERNAME
      password: $DOCKERHUB_PASSWORD
      tag: $VERSION
      repository: beoi/beoi-contest-platform
      registry: https://registry.hub.docker.com
    - internal/docker-push:
      username: $DOCKERHUB_USERNAME
      password: $DOCKERHUB_PASSWORD
      tag: latest
      repository: beoi/beoi-contest-platform
      registry: https://registry.hub.docker.com
new-eb-version:
  steps:
    - edgecaseadmin/install-aws-cli:
      key: $AWS_KEY
      secret: $AWS_SECRET
      region: eu-central-1
    - script:
      name: upload new version
      code: |
        VERSION="`cat $WERCKER_CACHE_DIR/VERSION`"
        REPOSITORY="beoi/beoi-contest-platform"
        IMAGENAME=$VERSION
        BUCKETNAME=elasticbeanstalk-eu-central-1-997893130250
        BUCKETPREFIX=contest-platform/
        BUCKETREGION=eu-central-1
        EBAPPNAME=contest-platform
        EBREGION=eu-central-1
        echo "{
          \"AWSEBDockerrunVersion\": \"1\",
          \"Image\": {
            \"Name\": \"$REPOSITORY/$IMAGENAME\",
            \"Update\": \"true\"
          },
          \"Ports\": [
            {
              \"ContainerPort\": \"80\"
            }
          ],
          \"Logging\": \"/var/www/html/logs\"
        }" > Dockerrun.aws.json
        zip -r RELEASE.zip Dockerrun.aws.json .ebextensions
        aws s3 cp RELEASE.zip s3://$BUCKETNAME/$BUCKETPREFIX$VERSION --region $BUCKETREGION
        aws elasticbeanstalk create-application-version --application-name $APPNAME --region $EBREGION --version-label $VERSION --source-bundle S3Bucket=$BUCKETNAME,S3Key=$BUCKETPREFIX$VERSION
